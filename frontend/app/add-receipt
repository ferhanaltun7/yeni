import React, { useState } from â€˜reactâ€™;
import {
View,
Text,
StyleSheet,
TextInput,
TouchableOpacity,
ScrollView,
KeyboardAvoidingView,
Platform,
Alert,
ActivityIndicator,
} from â€˜react-nativeâ€™;
import { useRouter } from â€˜expo-routerâ€™;
import { SafeAreaView } from â€˜react-native-safe-area-contextâ€™;
import { Ionicons } from â€˜@expo/vector-iconsâ€™;
import DateTimePicker from â€˜@react-native-community/datetimepickerâ€™;
import { receiptsAPI } from â€˜../src/services/apiâ€™;
import { scanReceipt, scanReceiptFromGallery, ReceiptScanResult } from â€˜../src/services/ocrServiceâ€™;
import { COLORS, RECEIPT_CATEGORY_COLORS, RECEIPT_CATEGORY_ICONS, RECEIPT_CATEGORY_NAMES, RECEIPT_CATEGORY_GROUPS } from â€˜../src/utils/constantsâ€™;

// Confidence thresholds
const HIGH_CONFIDENCE = 0.70;

// Field warning state
interface FieldConfidence {
storeName: â€˜highâ€™ | â€˜mediumâ€™ | â€˜lowâ€™ | â€˜noneâ€™;
amount: â€˜highâ€™ | â€˜mediumâ€™ | â€˜lowâ€™ | â€˜noneâ€™;
date: â€˜highâ€™ | â€˜mediumâ€™ | â€˜lowâ€™ | â€˜noneâ€™;
}

export default function AddReceipt() {
const router = useRouter();
const [storeName, setStoreName] = useState(â€™â€™);
const [amount, setAmount] = useState(â€™â€™);
const [receiptDate, setReceiptDate] = useState(new Date());
const [showDatePicker, setShowDatePicker] = useState(false);
const [category, setCategory] = useState(â€˜marketâ€™);
const [notes, setNotes] = useState(â€™â€™);
const [submitting, setSubmitting] = useState(false);
const [scanning, setScanning] = useState(false);
const [rawOcrText, setRawOcrText] = useState<string | null>(null);
const [showRawText, setShowRawText] = useState(false);
const [warnings, setWarnings] = useState<string[]>([]);
const [fieldConfidence, setFieldConfidence] = useState<FieldConfidence>({
storeName: â€˜noneâ€™,
amount: â€˜noneâ€™,
date: â€˜noneâ€™,
});

// Get border color based on confidence level
const getConfidenceBorderColor = (level: â€˜highâ€™ | â€˜mediumâ€™ | â€˜lowâ€™ | â€˜noneâ€™) => {
switch (level) {
case â€˜highâ€™: return COLORS.success;
case â€˜mediumâ€™: return COLORS.warning;
case â€˜lowâ€™: return COLORS.danger;
default: return COLORS.border;
}
};

const handleDateChange = (event: any, selectedDate?: Date) => {
setShowDatePicker(Platform.OS === â€˜iosâ€™);
if (selectedDate) setReceiptDate(selectedDate);
};

const handleScanResult = (result: ReceiptScanResult) => {
setWarnings(result.warnings || []);

```
const newConfidence: FieldConfidence = {
  storeName: 'none',
  amount: 'none',
  date: 'none',
};

if (result.rawText) {
  setRawOcrText(result.rawText);
}

if (result.success) {
  const alertMessages: string[] = [];
  
  // Process store name
  if (result.storeName) {
    setStoreName(result.storeName);
    const hasStoreWarning = result.warnings.some(w => w.includes('MaÄŸaza'));
    newConfidence.storeName = hasStoreWarning ? 'medium' : 'high';
    
    if (hasStoreWarning) {
      alertMessages.push(`âš ï¸ MaÄŸaza: "${result.storeName}" - doÄŸrulayÄ±n`);
    }
  }

  // Process amount
  if (result.amount !== undefined && result.amount > 0) {
    setAmount(result.amount.toFixed(2));
    const hasAmountWarning = result.warnings.some(w => w.includes('Tutar'));
    newConfidence.amount = hasAmountWarning ? 'medium' : 'high';
    
    if (hasAmountWarning) {
      alertMessages.push(`âš ï¸ Tutar: ${result.amount.toFixed(2)} TL - doÄŸrulayÄ±n`);
    }
  }

  // Process date
  if (result.receiptDate) {
    try {
      const d = new Date(result.receiptDate);
      if (!isNaN(d.getTime())) {
        setReceiptDate(d);
        const hasDateWarning = result.warnings.some(w => w.includes('Tarih'));
        newConfidence.date = hasDateWarning ? 'medium' : 'high';
        
        if (hasDateWarning) {
          alertMessages.push(`âš ï¸ Tarih: ${d.toLocaleDateString('tr-TR')} - doÄŸrulayÄ±n`);
        }
      }
    } catch {}
  }

  // Process category
  if (result.category) {
    setCategory(result.category);
  }

  setFieldConfidence(newConfidence);

  const hasAnyData = result.storeName || result.amount || result.receiptDate;
  const hasMediumConfidence = Object.values(newConfidence).some(c => c === 'medium');
  
  if (hasMediumConfidence && alertMessages.length > 0) {
    Alert.alert(
      'ðŸ” Tarama TamamlandÄ±', 
      `BazÄ± alanlar dÃ¼ÅŸÃ¼k gÃ¼venle Ã§Ä±karÄ±ldÄ±:\n\n${alertMessages.join('\n')}\n\nSarÄ± kenarlÄ± alanlarÄ± kontrol edin.`,
      [{ text: 'Tamam' }]
    );
  } else if (hasAnyData) {
    Alert.alert(
      'âœ… Tarama BaÅŸarÄ±lÄ±', 
      'FiÅŸ bilgileri yÃ¼ksek gÃ¼venle dolduruldu. Kontrol edip kaydedin.',
      [{ text: 'Tamam' }]
    );
  } else if (result.error) {
    Alert.alert('UyarÄ±', result.error);
  }
} else {
  Alert.alert('Hata', result.error || 'Tarama baÅŸarÄ±sÄ±z oldu.');
}
```

};

const handleScanReceipt = async (useCamera: boolean) => {
setScanning(true);
setRawOcrText(null);
setWarnings([]);

```
try {
  const result = useCamera ? await scanReceipt(true) : await scanReceiptFromGallery();
  handleScanResult(result);
} catch (error) {
  console.error('Scan error:', error);
  Alert.alert('Hata', 'Tarama sÄ±rasÄ±nda hata oluÅŸtu.');
} finally {
  setScanning(false);
}
```

};

const showScanOptions = () => {
Alert.alert(â€˜FiÅŸi Taraâ€™, â€˜FiÅŸ fotoÄŸrafÄ±nÄ± nasÄ±l eklemek istersiniz?â€™, [
{ text: â€˜Ä°ptalâ€™, style: â€˜cancelâ€™ },
{ text: â€˜Galeriden SeÃ§â€™, onPress: () => handleScanReceipt(false) },
{ text: â€˜FotoÄŸraf Ã‡ekâ€™, onPress: () => handleScanReceipt(true) },
]);
};

const handleSubmit = async () => {
if (!storeName.trim()) {
Alert.alert(â€˜Hataâ€™, â€˜LÃ¼tfen maÄŸaza adÄ± girinâ€™);
return;
}
if (!amount || parseFloat(amount) <= 0) {
Alert.alert(â€˜Hataâ€™, â€˜LÃ¼tfen geÃ§erli bir tutar girinâ€™);
return;
}

```
setSubmitting(true);
try {
  await receiptsAPI.create({
    store_name: storeName.trim(),
    amount: parseFloat(amount.replace(/[^0-9.]/g, '')),
    receipt_date: receiptDate.toISOString(),
    category,
    notes: notes.trim() || undefined,
  });
  Alert.alert('BaÅŸarÄ±lÄ±', 'FiÅŸ eklendi!', [
    { text: 'Tamam', onPress: () => router.back() },
  ]);
} catch (error) {
  console.error('Add receipt error:', error);
  Alert.alert('Hata', 'FiÅŸ eklenirken hata oluÅŸtu');
} finally {
  setSubmitting(false);
}
```

};

return (
<SafeAreaView style={styles.container} edges={[â€˜leftâ€™, â€˜rightâ€™, â€˜bottomâ€™]}>
<KeyboardAvoidingView behavior={Platform.OS === â€˜iosâ€™ ? â€˜paddingâ€™ : â€˜heightâ€™} style={styles.keyboardView}>
<ScrollView showsVerticalScrollIndicator={false} contentContainerStyle={styles.scrollContent}>

```
      {/* Scan Button */}
      <TouchableOpacity
        style={[styles.scanButton, scanning && styles.scanButtonActive]}
        onPress={showScanOptions}
        disabled={scanning}
      >
        {scanning ? (
          <ActivityIndicator color={COLORS.secondary} size="small" />
        ) : (
          <Ionicons name="camera" size={28} color={COLORS.secondary} />
        )}
        <View style={styles.scanTextContainer}>
          <Text style={styles.scanButtonText}>
            {scanning ? 'FiÅŸ TaranÄ±yor...' : 'FiÅŸi Tara'}
          </Text>
          <Text style={styles.scanButtonSubtext}>
            {scanning ? 'Google Vision + AI iÅŸleniyor' : 'Kamera ile otomatik bilgi Ã§Ä±karma'}
          </Text>
        </View>
        {!scanning && <Ionicons name="chevron-forward" size={20} color={COLORS.textSecondary} />}
      </TouchableOpacity>

      {/* Warnings */}
      {warnings.length > 0 && (
        <View style={styles.warningsContainer}>
          <Ionicons name="warning" size={18} color={COLORS.warning} />
          <Text style={styles.warningsText}>{warnings.join(' â€¢ ')}</Text>
        </View>
      )}

      {/* Raw OCR Text Preview */}
      {rawOcrText && (
        <View style={styles.rawTextContainer}>
          <TouchableOpacity style={styles.rawTextHeader} onPress={() => setShowRawText(!showRawText)}>
            <View style={styles.rawTextHeaderLeft}>
              <Ionicons name="document-text-outline" size={18} color={COLORS.textSecondary} />
              <Text style={styles.rawTextTitle}>Taranan Metin</Text>
            </View>
            <Ionicons name={showRawText ? 'chevron-up' : 'chevron-down'} size={18} color={COLORS.textSecondary} />
          </TouchableOpacity>
          {showRawText && (
            <Text style={styles.rawTextContent} numberOfLines={12}>{rawOcrText}</Text>
          )}
        </View>
      )}

      <View style={styles.dividerContainer}>
        <View style={styles.divider} />
        <Text style={styles.dividerText}>veya manuel girin</Text>
        <View style={styles.divider} />
      </View>

      {/* Store Name */}
      <View style={styles.inputGroup}>
        <View style={styles.labelRow}>
          <Text style={styles.label}>MaÄŸaza AdÄ± *</Text>
          {fieldConfidence.storeName !== 'none' && (
            <View style={[styles.confidenceBadge, { backgroundColor: getConfidenceBorderColor(fieldConfidence.storeName) + '20' }]}>
              <Ionicons 
                name={fieldConfidence.storeName === 'high' ? 'checkmark-circle' : 'alert-circle'} 
                size={12} 
                color={getConfidenceBorderColor(fieldConfidence.storeName)} 
              />
              <Text style={[styles.confidenceText, { color: getConfidenceBorderColor(fieldConfidence.storeName) }]}>
                {fieldConfidence.storeName === 'high' ? 'AI âœ“' : 'Kontrol edin'}
              </Text>
            </View>
          )}
        </View>
        <TextInput
          style={[
            styles.input,
            fieldConfidence.storeName !== 'none' && { 
              borderColor: getConfidenceBorderColor(fieldConfidence.storeName),
              borderWidth: 2 
            }
          ]}
          value={storeName}
          onChangeText={(text) => {
            setStoreName(text);
            if (fieldConfidence.storeName !== 'none') {
              setFieldConfidence(prev => ({ ...prev, storeName: 'none' }));
            }
          }}
          placeholder="Ã–rn: Migros, BÄ°M, Starbucks"
          placeholderTextColor={COLORS.textLight}
        />
      </View>

      {/* Amount */}
      <View style={styles.inputGroup}>
        <View style={styles.labelRow}>
          <Text style={styles.label}>Tutar *</Text>
          {fieldConfidence.amount !== 'none' && (
            <View style={[styles.confidenceBadge, { backgroundColor: getConfidenceBorderColor(fieldConfidence.amount) + '20' }]}>
              <Ionicons 
                name={fieldConfidence.amount === 'high' ? 'checkmark-circle' : 'alert-circle'} 
                size={12} 
                color={getConfidenceBorderColor(fieldConfidence.amount)} 
              />
              <Text style={[styles.confidenceText, { color: getConfidenceBorderColor(fieldConfidence.amount) }]}>
                {fieldConfidence.amount === 'high' ? 'AI âœ“' : 'Kontrol edin'}
              </Text>
            </View>
          )}
        </View>
        <View style={styles.amountContainer}>
          <TextInput
            style={[
              styles.input, 
              styles.amountInput,
              fieldConfidence.amount !== 'none' && { 
                borderColor: getConfidenceBorderColor(fieldConfidence.amount),
                borderWidth: 2 
              }
            ]}
            value={amount}
            onChangeText={(text) => {
              setAmount(text);
              if (fieldConfidence.amount !== 'none') {
                setFieldConfidence(prev => ({ ...prev, amount: 'none' }));
              }
            }}
            placeholder="0.00"
            placeholderTextColor={COLORS.textLight}
            keyboardType="decimal-pad"
          />
          <View style={styles.currencyBadge}>
            <Text style={styles.currencyText}>TL</Text>
          </View>
        </View>
      </View>

      {/* Receipt Date */}
      <View style={styles.inputGroup}>
        <View style={styles.labelRow}>
          <Text style={styles.label}>FiÅŸ Tarihi *</Text>
          {fieldConfidence.date !== 'none' && (
            <View style={[styles.confidenceBadge, { backgroundColor: getConfidenceBorderColor(fieldConfidence.date) + '20' }]}>
              <Ionicons 
                name={fieldConfidence.date === 'high' ? 'checkmark-circle' : 'alert-circle'} 
                size={12} 
                color={getConfidenceBorderColor(fieldConfidence.date)} 
              />
              <Text style={[styles.confidenceText, { color: getConfidenceBorderColor(fieldConfidence.date) }]}>
                {fieldConfidence.date === 'high' ? 'AI âœ“' : 'Kontrol edin'}
              </Text>
            </View>
          )}
        </View>
        <TouchableOpacity 
          style={[
            styles.dateButton,
            fieldConfidence.date !== 'none' && { 
              borderColor: getConfidenceBorderColor(fieldConfidence.date),
              borderWidth: 2 
            }
          ]} 
          onPress={() => {
            setShowDatePicker(true);
            if (fieldConfidence.date !== 'none') {
              setFieldConfidence(prev => ({ ...prev, date: 'none' }));
            }
          }}
        >
          <Ionicons name="calendar" size={20} color={COLORS.secondary} />
          <Text style={styles.dateText}>
            {receiptDate.toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric' })}
          </Text>
        </TouchableOpacity>
        {showDatePicker && (
          <DateTimePicker
            value={receiptDate}
            mode="date"
            display={Platform.OS === 'ios' ? 'spinner' : 'default'}
            onChange={handleDateChange}
            locale="tr-TR"
            maximumDate={new Date()}
          />
        )}
      </View>

      {/* Category */}
      <View style={styles.inputGroup}>
        <Text style={styles.label}>Kategori</Text>
        {RECEIPT_CATEGORY_GROUPS.map((group) => (
          <View key={group.id} style={styles.categoryGroup}>
            <View style={styles.categoryGroupHeader}>
              <Ionicons name={group.icon as any} size={18} color={COLORS.textSecondary} />
              <Text style={styles.categoryGroupTitle}>{group.name}</Text>
            </View>
            <View style={styles.categoryGrid}>
              {group.subcategories.map((catId) => (
                <TouchableOpacity
                  key={catId}
                  style={[
                    styles.categoryButton,
                    category === catId && styles.categoryButtonActive,
                    category === catId && { backgroundColor: RECEIPT_CATEGORY_COLORS[catId] + '20', borderColor: RECEIPT_CATEGORY_COLORS[catId] },
                  ]}
                  onPress={() => setCategory(catId)}
                >
                  <Ionicons
                    name={RECEIPT_CATEGORY_ICONS[catId] as any}
                    size={18}
                    color={category === catId ? RECEIPT_CATEGORY_COLORS[catId] : COLORS.textSecondary}
                  />
                  <Text style={[styles.categoryText, category === catId && { color: RECEIPT_CATEGORY_COLORS[catId] }]}>
                    {RECEIPT_CATEGORY_NAMES[catId]}
                  </Text>
                </TouchableOpacity>
              ))}
            </View>
          </View>
        ))}
      </View>

      {/* Notes */}
      <View style={styles.inputGroup}>
        <Text style={styles.label}>Notlar (Opsiyonel)</Text>
        <TextInput
          style={[styles.input, styles.notesInput]}
          value={notes}
          onChangeText={setNotes}
          placeholder="Ek bilgiler..."
          placeholderTextColor={COLORS.textLight}
          multiline
          numberOfLines={3}
          textAlignVertical="top"
        />
      </View>
    </ScrollView>

    {/* Submit Button */}
    <View style={styles.footer}>
      <TouchableOpacity
        style={[styles.submitButton, (!storeName.trim() || !amount || submitting) && styles.submitButtonDisabled]}
        onPress={handleSubmit}
        disabled={!storeName.trim() || !amount || submitting}
      >
        {submitting ? (
          <ActivityIndicator color="#fff" size="small" />
        ) : (
          <>
            <Ionicons name="checkmark-circle" size={24} color="#fff" />
            <Text style={styles.submitButtonText}>FiÅŸi Kaydet</Text>
          </>
        )}
      </TouchableOpacity>
    </View>
  </KeyboardAvoidingView>
</SafeAreaView>
```

);
}

const styles = StyleSheet.create({
container: { flex: 1, backgroundColor: COLORS.background },
keyboardView: { flex: 1 },
scrollContent: { padding: 20 },
scanButton: {
flexDirection: â€˜rowâ€™,
alignItems: â€˜centerâ€™,
backgroundColor: COLORS.secondary + â€˜10â€™,
borderRadius: 16,
padding: 16,
marginBottom: 12,
borderWidth: 2,
borderColor: COLORS.secondary + â€˜30â€™,
borderStyle: â€˜dashedâ€™,
},
scanButtonActive: { borderColor: COLORS.secondary, backgroundColor: COLORS.secondary + â€˜15â€™ },
scanTextContainer: { flex: 1, marginLeft: 12 },
scanButtonText: { fontSize: 16, fontWeight: â€˜600â€™, color: COLORS.secondary },
scanButtonSubtext: { fontSize: 12, color: COLORS.textSecondary, marginTop: 2 },
warningsContainer: {
flexDirection: â€˜rowâ€™,
alignItems: â€˜centerâ€™,
backgroundColor: COLORS.warning + â€˜15â€™,
padding: 12,
borderRadius: 10,
marginBottom: 12,
gap: 8,
},
warningsText: { flex: 1, fontSize: 13, color: COLORS.warning, fontWeight: â€˜500â€™ },
rawTextContainer: {
backgroundColor: COLORS.surface,
borderRadius: 12,
marginBottom: 12,
borderWidth: 1,
borderColor: COLORS.border,
overflow: â€˜hiddenâ€™,
},
rawTextHeader: {
flexDirection: â€˜rowâ€™,
alignItems: â€˜centerâ€™,
justifyContent: â€˜space-betweenâ€™,
padding: 12,
backgroundColor: COLORS.background,
},
rawTextHeaderLeft: { flexDirection: â€˜rowâ€™, alignItems: â€˜centerâ€™, gap: 8 },
rawTextTitle: { fontSize: 14, fontWeight: â€˜500â€™, color: COLORS.textSecondary },
rawTextContent: {
padding: 12,
fontSize: 11,
color: COLORS.text,
lineHeight: 16,
fontFamily: Platform.OS === â€˜iosâ€™ ? â€˜Menloâ€™ : â€˜monospaceâ€™,
},
dividerContainer: { flexDirection: â€˜rowâ€™, alignItems: â€˜centerâ€™, marginVertical: 16 },
divider: { flex: 1, height: 1, backgroundColor: COLORS.border },
dividerText: { marginHorizontal: 12, fontSize: 12, color: COLORS.textSecondary },
inputGroup: { marginBottom: 20 },
labelRow: {
flexDirection: â€˜rowâ€™,
alignItems: â€˜centerâ€™,
justifyContent: â€˜space-betweenâ€™,
marginBottom: 8,
},
label: { fontSize: 14, fontWeight: â€˜600â€™, color: COLORS.text },
confidenceBadge: {
flexDirection: â€˜rowâ€™,
alignItems: â€˜centerâ€™,
paddingHorizontal: 8,
paddingVertical: 4,
borderRadius: 8,
gap: 4,
},
confidenceText: {
fontSize: 11,
fontWeight: â€˜600â€™,
},
input: {
backgroundColor: COLORS.surface,
borderRadius: 12,
paddingHorizontal: 16,
paddingVertical: 14,
fontSize: 16,
color: COLORS.text,
borderWidth: 1,
borderColor: COLORS.border,
},
amountContainer: { position: â€˜relativeâ€™ },
amountInput: { paddingRight: 50 },
currencyBadge: { position: â€˜absoluteâ€™, right: 16, top: â€˜50%â€™, transform: [{ translateY: -10 }] },
currencyText: { fontSize: 16, fontWeight: â€˜600â€™, color: COLORS.secondary },
dateButton: {
flexDirection: â€˜rowâ€™,
alignItems: â€˜centerâ€™,
backgroundColor: COLORS.surface,
borderRadius: 12,
paddingHorizontal: 16,
paddingVertical: 14,
borderWidth: 1,
borderColor: COLORS.border,
gap: 12,
},
dateText: { fontSize: 16, color: COLORS.text },
categoryGroup: { marginBottom: 16 },
categoryGroupHeader: { flexDirection: â€˜rowâ€™, alignItems: â€˜centerâ€™, marginBottom: 10, gap: 6 },
categoryGroupTitle: { fontSize: 13, fontWeight: â€˜600â€™, color: COLORS.textSecondary, textTransform: â€˜uppercaseâ€™, letterSpacing: 0.5 },
categoryGrid: { flexDirection: â€˜rowâ€™, flexWrap: â€˜wrapâ€™, gap: 8 },
categoryButton: {
flexDirection: â€˜rowâ€™,
alignItems: â€˜centerâ€™,
paddingHorizontal: 12,
paddingVertical: 10,
borderRadius: 10,
backgroundColor: COLORS.surface,
borderWidth: 1,
borderColor: COLORS.border,
gap: 6,
},
categoryButtonActive: { borderWidth: 2 },
categoryText: { fontSize: 13, fontWeight: â€˜500â€™, color: COLORS.textSecondary },
notesInput: { height: 100, paddingTop: 14 },
footer: {
padding: 20,
paddingBottom: Platform.OS === â€˜iosâ€™ ? 20 : 20,
backgroundColor: COLORS.surface,
borderTopWidth: 1,
borderTopColor: COLORS.border,
},
submitButton: {
flexDirection: â€˜rowâ€™,
alignItems: â€˜centerâ€™,
justifyContent: â€˜centerâ€™,
backgroundColor: COLORS.secondary,
paddingVertical: 16,
borderRadius: 12,
gap: 8,
},
submitButtonDisabled: { backgroundColor: COLORS.textLight },
submitButtonText: { color: â€˜#fffâ€™, fontSize: 18, fontWeight: â€˜600â€™ },
});
